# NeoJiLang 更新日志

## [0.1.10] - 2025-06-15

### 新增功能

- 添加了终端控制模块 `!shell`：
  - `shell.color` - 设置文本颜色，支持前景色、背景色和加粗效果
  - `shell.style` - 设置文本样式，如加粗、下划线和闪烁
  - `shell.clear_line` - 清除当前行并将光标移到行首
  - `shell.write` - 写入文本（不换行）
  - `shell.write_line` - 写入文本并换行
  - `shell.overwrite` - 清除当前行并写入新文本
  - 支持的颜色包括：`black`, `red`, `green`, `yellow`, `blue`, `magenta`, `cyan`, `white`
  - 可用于创建丰富的终端用户界面，如进度条、彩色提示信息等

### 架构改进

- 扩展了内置模块系统，增加了终端控制功能
- 实现了 `ShellModule` 结构体，提供一系列终端控制语句处理器
- 使用 ANSI 转义序列实现了终端颜色和样式控制
- 添加了示例程序，展示如何使用 shell 模块创建进度条和彩色输出

## [0.1.9] - 2025-06-10

### 新增功能

- 添加了延时执行功能：
  - 新增 `sleep` 指令，支持程序执行的暂停
  - 支持毫秒和秒两种时间单位：
    - 默认以毫秒为单位，如 `{"sleep": 1000}` 暂停1秒
    - 使用对象格式可指定单位，如 `{"sleep": {"duration": 1, "unit": "s"}}` 暂停1秒
  - 提供别名 `delay` 和 `wait`，方便不同习惯的用户使用
  - 可用于实现动画效果、模拟耗时操作、限制API请求频率等场景

### 架构改进

- 增强了内置模块系统，添加了时间控制相关功能
- 实现了 `SleepHandler` 处理器，负责处理延时相关指令
- 优化了解释器执行流程，确保延时不会阻塞整个程序的执行
- 为延时功能添加了完整的单元测试和示例程序

## [0.1.8] - 2025-06-01

### 新增功能

- 添加了日期和时间处理模块 `datetime`：
  - `datetime.date` - 获取当前日期，支持自定义格式
  - `datetime.time` - 获取当前时间，支持自定义格式
  - 提供了别名 `date` 和 `time`，方便直接使用
  - 支持多种格式化选项：
    - 默认日期格式为 `%Y-%m-%d`（YYYY-MM-DD）
    - 默认时间格式为 `%H:%M:%S`（HH:MM:SS）
    - 支持通过字符串参数直接指定格式，如 `{"date": "%d/%m/%Y"}`
    - 支持通过对象格式指定格式，如 `{"date": {"format": "%Y年%m月%d日"}}`

- 变量设置简洁模式回归：
  - 添加了 `var.set.m` 指令，支持简洁的键值对格式设置变量
  - 支持一次性设置多个变量，如 `{"var.set.m": {"name": "张三", "age": 30}}`
  - 支持设置复杂的嵌套结构，如 `{"var.set.m": {"person": {"name": "李四", "address": {"city": "北京"}}}}`
  - 支持直接修改嵌套属性，如 `{"var.set.m": {"person.name": "王五", "person.address.city": "上海"}}`
  - 提供别名 `var.m` 以便于使用
  - 保留了原有的 `var.set` 结构化格式，同时支持两种变量设置风格

### 架构改进

- 扩展了内置模块系统，增加了日期时间处理能力
- 添加了 `chrono` 依赖，提供强大的日期和时间处理功能
- 增强了测试系统，为日期和时间功能添加了单元测试
- 重构了变量设置处理器：
  - 添加了 `VarSetMultiHandler` 类，处理简洁格式的变量设置
  - 优化了 `value_to_string` 方法，正确处理嵌套变量路径的字符串插值
  - 将 `get_nested_variable` 改为公共函数，便于在不同地方复用
  - 更新了语句处理器注册系统，支持多种变量设置格式

## [0.1.7] - 2025-05-31

- 才发现 0.1.6 Release 的时候没 Push 到GitHub...
- 导致 0.1.6 Release 的 Source code 还是 0.1.5 的（但exe确实是0.1.6）
- 抱歉

### 新增功能

- 添加了JSON文件中的注释支持：
  - 支持单行注释（`// 这是单行注释`）
  - 支持多行注释（`/* 这是多行注释 */`）
  - 在解析JSON之前自动移除注释，不影响JSON的有效性
  - NJIL和NJIS格式均支持注释功能
  - 字符串内的注释符号不会被处理（如 `"这不是 // 注释"`）

### 架构改进

- 添加了预处理器模块，用于在解析JSON之前处理文件内容：
  - 实现了`Preprocessor`结构体，提供文件和内容的预处理功能
  - 添加了`preprocess_file`和`preprocess_content`方法，用于移除注释
  - 改进了错误处理，提供更友好的解析错误信息
- 优化了文件加载流程，增加了预处理步骤：
  - 修改了`Interpreter::load_file`方法，使用预处理器处理文件内容
  - 修改了NJIS相关函数，使其也支持注释功能

## [0.1.6] - 2025-05-31

### 新增功能

- 实现了函数调用功能，支持在NJIL程序中定义和调用自定义函数：
  - 新增 `function.call` 语句处理器，支持调用程序中定义的函数
  - 实现了函数参数传递机制，支持位置参数 ($1, $2, ...)
  - 支持函数返回值的处理和传递
  - 支持嵌套函数调用，如 `function.call(name="greet", args=[function.call(name="calculate", args=[5, 15])])`
  - 添加了别名 `call` 和 `func.call` 以便于使用
  - function 仅支持 NJIL（NeoJiLang） 格式，NJIS（NeoJi Script） 不支持

### 架构改进

- 增强了解释器对函数调用的支持：
  - 添加了 `call_function` 方法处理函数调用逻辑
  - 实现了 `get_function` 方法从当前程序中查找函数定义
  - 优化了 `VarSetHandler` 的实现，改进了嵌套表达式的评估逻辑
  - 扩展了 `evaluate_value` 方法以处理函数调用表达式
- 改进了函数作用域隔离，每个函数调用在独立的变量环境中执行
- 添加了 `current_program` 字段到 `Interpreter` 结构体，跟踪当前加载的程序

- 重构了算术运算模块，提高代码组织和可维护性：
  - 将算术运算处理器拆分为独立的文件，每个处理器负责特定的操作
  - 创建了专用的算术运算处理器：`add.rs`、`subtract.rs`、`multiply.rs`、`divide.rs`、`modulo.rs`和`compare.rs`
  - 优化了处理器结构，使每个处理器更专注于其特定的功能
  - 改进了算术运算处理器的错误处理机制，提供更清晰的错误信息

- 增强了比较运算功能，实现更完善的比较逻辑：
  - 新增了`math.compare`处理器，支持多种比较运算符（`==`、`!=`、`>`、`>=`、`<`、`<=`）
  - 实现了类型感知的比较逻辑，不同类型的值遵循特定的比较规则
  - 改进了数值比较的精度控制，处理浮点数比较的特殊情况
  - 增强了字符串比较功能，支持字典序比较

- 完善了取模运算功能：
  - 新增了`math.modulo`处理器，支持数值取模运算
  - 实现了专用的取模运算逻辑，提供完整的参数验证和错误处理
  - 支持被除数(dividend)和除数(divisor)参数，计算模运算的结果
  - 处理零除错误情况，返回适当的结果

- 重构了类型转换模块，提高代码组织和可维护性：
  - 将单一的 `type_convert.rs` 文件拆分为多个专用文件
  - 创建了专用的子模块：`bool_convert.rs`、`number_convert.rs`、`string_convert.rs`、`array_convert.rs`、`object_convert.rs`、`arithmetic.rs` 和 `comparison.rs`
  - 每个子模块专注于一种特定的类型转换或操作，降低了代码复杂度
  - 优化了模块间的依赖关系，提高了代码的可读性和可维护性

- 重构了控制流模块，提高代码组织和可维护性：
  - 将单一的 `control_flow.rs` 文件拆分为多个专用文件
  - 创建了专用的子模块：`if_stmt.rs`、`while_loop.rs`、`for_loop.rs`、`foreach_loop.rs` 和 `break_continue.rs`
  - 改进了语句处理器的注册机制，使用集中管理的方式统一注册控制流处理器
  - 优化了代码组织结构，便于功能扩展和维护

- 添加了条件调试输出系统，提高开发和测试体验：
  - 引入 `--njil-debug` 命令行标志，只有在启用此标志时才显示调试信息
  - 添加 `debug_println!` 宏，用于条件打印调试信息
  - 实现 `set_debug_mode` 和 `is_debug_mode` 函数，管理全局调试状态
  - 改进命令行参数解析，支持标志和选项
  - 优化了调试输出的清晰度和有用性：
    - 函数调用的参数和返回值
    - 变量设置和评估结果
    - 语句执行过程和结果

- 优化了 `AddHandler` 的实现，根据操作数类型选择适当的初始值：
  - 对于字符串和数组类型，使用第一个操作数作为初始值
  - 对于其他类型，使用数值 `0` 作为初始值
- 改进了 `type_convert::add` 函数中字符串连接的处理逻辑

### 问题修复

- 修复了变量设置和显示问题：
  - 修复了`var.set`处理器的实现，确保正确解析和设置变量
  - 改进了`value_to_string`方法，支持变量引用的解析和替换
  - 优化了字符串模板中变量引用的处理，格式为`${var:name}`
  - 解决了变量引用中的借用冲突问题，提高代码稳定性

- 修复了弱类型系统中的连接操作bug：
  - 修复了字符串连接操作（如 `"Hello, " + "World!"`）结果中出现前缀 `0` 的问题
  - 修复了数组连接操作（如 `[1,2,3] + [4,5,6]`）结果中出现前缀 `0` 的问题
  - 优化了 `math.add` 处理器中字符串和数组连接的逻辑，正确处理不同类型的操作数
  - 改进了连接操作的性能和准确性

## [0.1.5] - 2025-05-30

### 新增功能

- 增强了弱类型系统，提供更强大的类型转换和运算能力：
  - 添加了类型转换模块，支持各种类型之间的智能转换
  - 新增了一系列类型转换语句：
    - `type.convert` - 通用类型转换
    - `type.bool` - 转换为布尔类型
    - `type.number` - 转换为数字类型
    - `type.string` - 转换为字符串类型
    - `type.array` - 转换为数组类型
    - `type.object` - 转换为对象类型
    - `type.of` - 获取值的类型
  - 实现了算术运算语句，支持不同类型之间的运算：
    - `math.add` - 加法运算，支持数字相加、字符串连接、数组合并等
    - `math.subtract` - 减法运算，支持数字相减、数组元素移除等
    - `math.multiply` - 乘法运算，支持数字相乘、字符串重复等
    - `math.divide` - 除法运算，支持数字相除、字符串分割等
    - `math.modulo` - 取模运算
    - `math.compare` - 比较运算，支持各种类型的比较
  - 所有运算都支持不同类型之间的智能转换

### 架构改进

- 添加了统一的类型转换工具模块 `utils::type_convert`，提供各种类型转换功能
- 优化了语句处理器的注册机制，添加了集中初始化函数
- 改进了解释器的启动过程，确保语句处理器正确初始化
- 增强了错误处理，提供更友好的类型转换错误信息

## [0.1.4] - 2025-05-30

### 新增功能

- 添加了逻辑运算语句支持：
  - `logic.and` - 逻辑与操作，支持短路求值
  - `logic.or` - 逻辑或操作，支持短路求值
  - `logic.not` - 逻辑非操作
- 所有逻辑运算支持不同数据类型的真值判断
- 逻辑运算可以与控制流语句结合使用，增强条件表达能力
- 增强了变量访问能力，支持嵌套变量路径：
  - 支持多层对象属性访问，如 `person.address.city`
  - 支持数组索引访问，如 `hobbies[0]`
  - 支持混合嵌套路径，如 `company.departments[0].employees[1].name`
  - 支持通过嵌套路径设置变量值，自动创建中间结构
- 实现了通用的路径解析和访问系统，统一处理变量和JSON嵌套路径：
  - 创建了专用的路径解析器，支持对象属性和数组索引混合的路径
  - 添加了`utils::path`模块，提供统一的路径操作功能
- 增强了JSON操作功能，支持嵌套路径访问和修改：
  - `json.get`支持通过点表示法访问嵌套属性，如`json.get(obj, "user.profile.name")`
  - `json.set`支持通过点表示法设置嵌套属性，如`json.set(obj, "user.address.city", "北京")`
  - `json.get`和`json.set`支持数组索引访问，如`"items[0].name"`
  - 自动创建嵌套路径中的中间结构（对象或数组）
- 优化了错误处理机制，提高了用户体验：
  - 在访问不存在的嵌套路径时返回`null`而不是抛出错误
  - 为嵌套路径访问提供更友好的错误信息

### 架构改进

- 扩展了错误提示系统，添加了逻辑运算相关的错误类型
- 优化了逻辑运算的短路求值机制，提高执行效率
- 添加了完整的逻辑运算示例程序
- 重构了变量处理机制，支持更复杂的变量路径解析
- 增强了变量路径解析器，能够处理对象属性和数组索引的混合路径
- 重构了路径处理系统，采用统一的路径解析和访问机制：
  - 定义了`PathPart`枚举，统一表示对象属性和数组索引
  - 实现了`parse_path`函数，将字符串路径解析为结构化的路径部分
  - 添加了`get_nested_value`和`set_nested_value`函数，用于统一处理嵌套值的获取和设置
- 优化了打印语句处理器，改进数组参数的处理方式：
  - `print`语句现在能正确处理数组参数，将其作为字符串连接处理
  - 改进了打印功能的变量替换机制，显示更友好的输出结果

### 问题修复

- 修复了无法通过嵌套路径访问变量的问题
- 修复了无法通过数组索引访问元素的问题
- 修复了无法通过嵌套路径设置变量值的问题
- 修复了在使用`json.set`时无法正确处理嵌套路径的问题
- 修复了`json.get`在路径不存在时抛出错误而不是返回`null`的问题
- 修复了在空对象上无法创建嵌套结构的问题
- 修复了`print`处理器无法正确处理数组参数的问题，导致变量值不被替换
- 消除了代码中的编译警告，提高代码质量

## [0.1.3] - 2025-05-29

### 新增功能

- 添加了完整的控制流语句支持：
  - `if` - 条件判断语句，支持 `then` 和可选的 `else` 分支
  - `loop.while` - 条件循环，当条件为真时重复执行
  - `loop.for` - 计数循环，执行指定次数
  - `loop.foreach` - 集合遍历循环，支持数组和对象
  - `loop.break` - 跳出当前循环
  - `loop.continue` - 跳过当前循环迭代，继续下一次迭代
- 所有控制流语句支持单个语句或语句数组作为执行体
- 循环语句支持变量绑定，可以访问当前迭代的索引和值

### 架构改进

- 增强了错误处理系统，添加了循环控制相关的错误类型
- 添加了控制流相关的错误提示信息，提高调试体验
- 优化了语句执行机制，支持嵌套控制流结构

## [0.1.2] - 2025-05-29

### 新增功能

- 扩展了核心语句集，实现了JSON操作系列语句，用于创建、查询和修改JSON数据结构：
  - `json.new` - 创建新的JSON对象或数组，支持嵌套语句
  - `json.get` - 获取JSON对象的属性或数组的元素
  - `json.set` - 设置JSON对象的属性或数组的元素
  - 所有JSON操作均支持变量引用和嵌套语句，实现复杂数据处理

### 架构改进

- 优化了语句处理机制，支持对象和数组的递归处理
- 改进了核心语句集的扩展机制，使添加新语句更加简便
- 增强了错误提示系统，提供更加详细的JSON操作错误信息

## [0.1.1] - 2025-05-28

### 新增功能

- 添加了内置模块系统和动态导入机制
- 实现了IO模块，提供文件读写和标准输入输出功能：
  - `io.readFile` - 读取文件内容，支持编码选项（UTF-8, GB2312/GBK）
  - `io.writeFile` - 写入文件，支持编码选项（UTF-8, GB2312/GBK）
  - `io.readLine` - 读取一行输入
  - `io.input` - 显示提示并读取输入
- 增强了NJIL导入系统，支持内置模块的导入
- NJIS现在会自动导入所有内置模块，无需显式声明
- 为两种文件格式添加了不同的模块加载策略：
  - NJIL: 按需加载，通过`import`语句显式声明
  - NJIS: 自动加载所有内置模块，简化使用
- 添加了通用内容解析方法，统一处理变量引用和表达式

### 架构改进

- 设计了`BuiltinModule`特性，统一内置模块的接口
- 实现了`BuiltinModuleRegistry`，用于管理和查找内置模块
- 增强了解释器，支持动态加载模块和处理导入语句
- 改进了语句注册系统，支持动态注册处理器

## [0.1.0] - 2025-05-28

### 新增功能

- 实现了基本的NJIL解释器框架
- 添加了核心语句处理功能：
  - `print` - 打印语句输出
  - `var` - 变量获取
  - `var.set` - 变量设置
  - `return` - 返回值处理
  - `string.concat` 和 `txtlink` - 字符串连接操作
- 引入了模块化的语句处理系统，使用`StatementHandler`特质
- 实现了动态语句处理器注册机制，支持语句别名
- 添加了集中式错误提示管理系统，便于国际化和维护
- 支持从文件加载和执行NJIL程序
- 添加了NJIS (NeoJi Script) 格式支持，使用`.njis`扩展名
  - NJIS是一种简化版的NJIL，使用JSON数组直接表示语句序列
  - 自动识别文件扩展名并选择适当的解析器

### 架构改进

- 采用模块化设计，将不同类型的语句处理逻辑分离到独立模块
- 使用特质（trait）定义统一的语句处理接口
- 实现了静态单例模式的语句处理器，提高性能
- 使用`OnceLock`实现线程安全的全局语句注册表
- 错误提示信息集中管理，便于维护和国际化